<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wazzup Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #wazzup-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 16px;
            color: #666;
        }
        #error {
            display: none;
            padding: 20px;
            color: #d32f2f;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="loading">Загрузка чата...</div>
    <div id="error"></div>
    <iframe id="wazzup-iframe" style="display:none;"></iframe>

    <script>
        const WAZZUP_CONFIG = {
            apiKey: 'f766c59becb94605b6d0cd84a5b5613e',
            baseUrl: 'https://api.wazzup24.com/v3/iframe'
        };

        // Функция для форматирования телефона
        function formatPhone(phone) {
            if (!phone) return null;
            
            // Убираем все нецифровые символы
            let cleaned = phone.replace(/\D/g, '');
            
            // Если начинается с 7 (Россия), меняем на +7
            if (cleaned.startsWith('7') && cleaned.length === 11) {
                return '+' + cleaned;
            }
            // Если начинается с 8 (Россия), меняем на +7
            if (cleaned.startsWith('8') && cleaned.length === 11) {
                return '+7' + cleaned.substring(1);
            }
            // Если начинается с 62 (Индонезия)
            if (cleaned.startsWith('62')) {
                return '+' + cleaned;
            }
            // В остальных случаях добавляем +
            return '+' + cleaned;
        }

        // Функция загрузки iframe
        function loadWazzupChat(phone) {
            const formattedPhone = formatPhone(phone);
            
            if (!formattedPhone) {
                showError('Номер телефона не указан');
                return;
            }

            // Формируем URL для Wazzup iframe
            const iframeUrl = `${WAZZUP_CONFIG.baseUrl}?token=${WAZZUP_CONFIG.apiKey}&phone=${encodeURIComponent(formattedPhone)}&transport=whatsapp`;
            
            console.log('Loading Wazzup iframe:', iframeUrl);
            
            const iframe = document.getElementById('wazzup-iframe');
            iframe.src = iframeUrl;
            iframe.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // Функция отображения ошибки
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Слушаем сообщения от Yclients
        window.addEventListener('message', function(event) {
            console.log('Received message from Yclients:', event.data);
            
            try {
                const data = event.data;
                
                // Проверяем наличие данных клиента
                if (data && data.client && data.client.phone) {
                    loadWazzupChat(data.client.phone);
                } else {
                    showError('Не удалось получить номер телефона клиента');
                }
            } catch (error) {
                console.error('Error processing message:', error);
                showError('Ошибка обработки данных: ' + error.message);
            }
        });

        // Для тестирования: проверяем URL параметры (если открыто напрямую)
        const urlParams = new URLSearchParams(window.location.search);
        const phoneParam = urlParams.get('phone');
        
        if (phoneParam) {
            console.log('Direct access with phone parameter');
            loadWazzupChat(phoneParam);
        }

        // Сообщаем Yclients что готовы принимать данные
        window.parent.postMessage({ type: 'ready' }, '*');
    </script>
</body>
</html>
