<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <!-- Фиксированная ширина под iframe Yclients -->
  <meta name="viewport" content="width=374">
  <title>Wazzup для Yclients</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 374px;
      height: 100vh;
      overflow: hidden;
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #222;
    }

    /* Верхняя панель */
    .topbar {
      height: 44px;
      padding: 0 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #f0f0f0;
      background: #ffffff;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #25D366, #128C7E);
    }

    .topbar-title {
      font-size: 14px;
      font-weight: 600;
      color: #222;
    }

    .topbar-logout {
      border: none;
      background: transparent;
      font-size: 12px;
      color: #999;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .topbar-logout:hover {
      background: #f5f5f5;
    }

    /* Контейнеры */
    #loader,
    #error,
    #chat-container {
      width: 100%;
      height: calc(100vh - 44px); /* минус topbar */
    }

    /* Loader */
    .loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #666;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #25D366;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    .loader p {
      font-size: 14px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Error State */
    .error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
    }

    .error h3 {
      font-size: 18px;
      color: #333;
      margin-bottom: 8px;
    }

    .error p {
      font-size: 14px;
      color: #666;
      margin-bottom: 16px;
    }

    .error button {
      padding: 10px 20px;
      background: #25D366;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .error button:hover {
      background: #1ebe57;
    }

    /* Chat Container */
    #chat-container {
      position: relative;
    }

    #wazzup-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Utility */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Верхняя панель -->
  <header class="topbar">
    <div class="topbar-left">
      <span class="logo-dot"></span>
      <span class="topbar-title">Чаты Wazzup</span>
    </div>
    <button id="logout-btn" class="topbar-logout" type="button">
      Выйти
    </button>
  </header>

  <!-- Loader -->
  <div id="loader" class="loader">
    <div class="spinner"></div>
    <p>Загрузка мессенджеров...</p>
  </div>

  <!-- Error State -->
  <div id="error" class="error hidden">
    <h3>Не удалось загрузить чаты</h3>
    <p id="error-message"></p>
    <button id="retry-btn" type="button">Попробовать снова</button>
  </div>

  <!-- Main iframe container -->
  <div id="chat-container" class="hidden">
    <iframe
      id="wazzup-iframe"
      frameborder="0"
      allowfullscreen
      title="Чаты Wazzup">
    </iframe>
  </div>

  <script>
    // ======= КОНФИГ (только для фронтового прототипа) =======
    const CONFIG = {
      WAZZUP_IFRAME_BASE: 'https://app.wazzup24.com/iframe',
      AUTH_REQUIRED: false // авторизацию можно включить позже
    };

    // ======= Телефон =======
    function formatPhone(phone) {
      if (!phone) return null;
      let cleaned = String(phone).replace(/\D/g, '');
      if (cleaned.startsWith('8') && cleaned.length === 11) {
        cleaned = '7' + cleaned.slice(1);
      }
      if (cleaned.length === 10) {
        cleaned = '7' + cleaned;
      }
      return '+' + cleaned;
    }

    function isValidPhone(phone) {
      if (!phone) return false;
      const cleaned = String(phone).replace(/\D/g, '');
      return cleaned.length >= 10 && cleaned.length <= 15;
    }

    // ======= Псевдо‑авторизация =======
    function isAuthorized() {
      if (!CONFIG.AUTH_REQUIRED) return true;
      return !!localStorage.getItem('wazzup_yclients_auth');
    }

    function logout() {
      localStorage.removeItem('wazzup_yclients_auth');
      try {
        window.parent.postMessage({ type: 'logout' }, '*');
      } catch (e) {}
      location.reload();
    }

    function showAuthError() {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-message').textContent =
        'Требуется авторизация для работы с мессенджерами.';
    }

    // ======= UI ошибки =======
    function showError(message) {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('chat-container').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-message').textContent =
        message || 'Произошла неизвестная ошибка.';
    }

    // ======= iframe Wazzup =======
    function buildWazzupIframeUrl(phone) {
      const params = new URLSearchParams({
        scope: 'card',
        phone: phone
      });
      return CONFIG.WAZZUP_IFRAME_BASE + '?' + params.toString();
    }

    function loadWazzupChat(phone) {
      const iframe = document.getElementById('wazzup-iframe');
      if (!iframe) return;

      const url = buildWazzupIframeUrl(phone);
      console.log('[loadWazzupChat] url =', url);
      iframe.src = url;

      iframe.onload = function () {
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('error').classList.add('hidden');
        document.getElementById('chat-container').classList.remove('hidden');
        try {
          window.parent.postMessage({ type: 'ready' }, '*');
        } catch (e) {}
      };

      iframe.onerror = function () {
        showError('Не удалось загрузить интерфейс Wazzup');
      };
    }

    // ======= Основная логика =======
    const urlParams   = new URLSearchParams(window.location.search);
    const salonId     = urlParams.get('salon_id');
    const clientId    = urlParams.get('client_id');
    const clientPhone = urlParams.get('client_phone');
    const clientName  = urlParams.get('client_name') || '';

    function validateRequiredParams() {
      if (!salonId || !clientId || !clientPhone) {
        console.error('Missing required params', { salonId, clientId, clientPhone });
        showError('Недостаточно данных для загрузки чата. Обратитесь к администратору.');
        throw new Error('Missing required parameters');
      }
    }

    function checkAuthOrFail() {
      if (!isAuthorized()) {
        showAuthError();
        throw new Error('Not authorized');
      }
    }

    async function init() {
      console.log('[init] start');
      document.getElementById('logout-btn').addEventListener('click', logout);
      document.getElementById('retry-btn').addEventListener('click', () => location.reload());

      try {
        validateRequiredParams();
        checkAuthOrFail();

        const formattedPhone = formatPhone(clientPhone);
        console.log('[init] phone:', clientPhone, '=>', formattedPhone);

        if (!formattedPhone || !isValidPhone(formattedPhone)) {
          showError('Номер телефона клиента указан некорректно.');
          throw new Error('Invalid phone');
        }

        // ВАЖНО: на этом прототипном этапе НИЧЕГО не шлём в Wazzup API,
        // только открываем iframe по номеру:
        loadWazzupChat(formattedPhone);
      } catch (e) {
        console.error('[init] error', e);
        if (!(e instanceof Error && e.message === 'Not authorized')) {
          showError('Ошибка инициализации: ' + (e.message || e));
        }
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
