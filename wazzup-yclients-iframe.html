<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wazzup Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        #wazzup-iframe {
            width: 100%;
            height: 100vh;
            border: none;
            display: block;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 16px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
        }
        
        .error h2 {
            color: #f44336;
            margin-bottom: 10px;
        }
        
        .error p {
            color: #666;
            line-height: 1.6;
        }
        
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Загрузка чата...</p>
    </div>
    
    <div id="error" class="error" style="display: none;">
        <h2>⚠️ Ошибка</h2>
        <p id="error-message"></p>
    </div>
    
    <iframe id="wazzup-iframe" style="display: none;"></iframe>
    
    <div id="debug-info" class="debug-info">
        <strong>Debug Info:</strong><br>
        <span id="debug-text"></span>
    </div>

    <script>
        // КОНФИГУРАЦИЯ
        const CONFIG = {
            // ВАШ API КЛЮЧ WAZZUP
            apiKey: '1182d7f92b7e43b8b32f74d0bd24fa80',
            
            // Базовый URL для iframe Wazzup
            baseUrl: 'https://api.wazzup24.com/v3/iframe',
            
            // Канал по умолчанию
            defaultTransport: 'whatsapp',
            
            // Включить режим отладки (показывает полученные данные)
            debugMode: false // Поставь true для отладки
        };

        // Переменная для хранения данных от Yclients
        let yclientsData = null;

        // Функция для отладки
        function debug(message, data) {
            if (CONFIG.debugMode) {
                console.log('[Wazzup Integration]', message, data || '');
                const debugDiv = document.getElementById('debug-info');
                const debugText = document.getElementById('debug-text');
                debugDiv.classList.add('show');
                debugText.innerHTML = `${message}<br>${data ? JSON.stringify(data, null, 2) : ''}`;
            }
        }

        // Функция для очистки номера телефона
        function cleanPhone(phone) {
            if (!phone) return '';
            
            // Удаляем все кроме цифр
            let cleaned = String(phone).replace(/\D/g, '');
            
            debug('Cleaning phone', { original: phone, cleaned: cleaned });
            
            // Убираем начальные 8 и заменяем на 7 для России
            if (cleaned.startsWith('8') && cleaned.length === 11) {
                cleaned = '7' + cleaned.substring(1);
            }
            
            // Для Индонезии оставляем как есть
            if (cleaned.startsWith('62')) {
                return cleaned;
            }
            
            // Для России добавляем 7 если нужно
            if (cleaned.length === 10 && cleaned[0] === '9') {
                cleaned = '7' + cleaned;
            }
            
            return cleaned;
        }

        // Функция для извлечения телефона из данных Yclients
        function extractPhone(data) {
            debug('Extracting phone from data', data);
            
            let phone = '';
            
            // Пробуем разные источники данных
            if (data.client && data.client.phone) {
                phone = data.client.phone;
                debug('Found phone in client', phone);
            } else if (data.staff && data.staff.phone) {
                phone = data.staff.phone;
                debug('Found phone in staff', phone);
            } else if (data.record && data.record.client && data.record.client.phone) {
                phone = data.record.client.phone;
                debug('Found phone in record.client', phone);
            } else if (data.phone) {
                phone = data.phone;
                debug('Found phone in root', phone);
            }
            
            return cleanPhone(phone);
        }

        // Функция для отображения ошибки
        function showError(message) {
            debug('Showing error', message);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        // Функция для загрузки Wazzup iframe
        function loadWazzupChat(phone) {
            try {
                debug('Loading Wazzup chat', { phone: phone });
                
                if (!phone) {
                    showError('Номер телефона не найден. Убедитесь, что у клиента/сотрудника есть номер телефона в карточке.');
                    return;
                }
                
                // Формируем URL для iframe
                let iframeUrl = `${CONFIG.baseUrl}?token=${CONFIG.apiKey}&phone=${phone}`;
                
                // Добавляем канал
                const transport = CONFIG.defaultTransport;
                if (transport) {
                    iframeUrl += `&transport=${transport}`;
                }
                
                debug('Loading iframe', { url: iframeUrl });
                
                // Загружаем iframe
                const iframe = document.getElementById('wazzup-iframe');
                iframe.src = iframeUrl;
                
                // Показываем iframe после загрузки
                iframe.onload = function() {
                    debug('Iframe loaded successfully');
                    document.getElementById('loading').style.display = 'none';
                    iframe.style.display = 'block';
                };
                
                // Обработка ошибок загрузки
                iframe.onerror = function(error) {
                    debug('Iframe load error', error);
                    showError('Не удалось загрузить чат. Проверьте настройки API ключа.');
                };
                
            } catch (error) {
                debug('Exception in loadWazzupChat', error);
                console.error('Ошибка:', error);
                showError('Произошла ошибка при загрузке чата: ' + error.message);
            }
        }

        // Функция для получения данных из URL параметров (для тестирования)
        function getUrlParams() {
            const params = {};
            const searchParams = new URLSearchParams(window.location.search);
            
            for (const [key, value] of searchParams.entries()) {
                params[key] = value;
            }
            
            return params;
        }

        // Обработка сообщений от Yclients (postMessage)
        window.addEventListener('message', function(event) {
            debug('Received postMessage', {
                origin: event.origin,
                data: event.data
            });
            
            // Проверяем что сообщение от Yclients
            if (event.origin.includes('yclients.com')) {
                yclientsData = event.data;
                
                // Извлекаем телефон
                const phone = extractPhone(event.data);
                
                if (phone) {
                    loadWazzupChat(phone);
                } else {
                    debug('No phone found in postMessage data');
                }
            }
        });

        // Инициализация при загрузке страницы
        window.addEventListener('DOMContentLoaded', function() {
            debug('Page loaded, initializing...');
            
            // Сначала проверяем URL параметры (для тестирования)
            const urlParams = getUrlParams();
            
            if (urlParams.phone) {
                debug('Found phone in URL params', urlParams);
                const phone = cleanPhone(urlParams.phone);
                loadWazzupChat(phone);
            } else {
                debug('Waiting for postMessage from Yclients...');
                
                // Отправляем сообщение родительскому окну что мы готовы
                if (window.parent !== window) {
                    window.parent.postMessage({ type: 'iframe_ready' }, '*');
                    debug('Sent iframe_ready to parent');
                }
                
                // Таймаут на случай если данные не придут
                setTimeout(function() {
                    if (!yclientsData) {
                        debug('Timeout: no data received from Yclients');
                        showError('Не удалось получить данные от Yclients. Попробуйте перезагрузить страницу.');
                    }
                }, 5000);
            }
        });
        
        // Отправляем событие что iframe загружен (для Yclients)
        window.addEventListener('load', function() {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'wazzup_iframe_loaded',
                    ready: true
                }, '*');
                debug('Sent loaded event to parent');
            }
        });
    </script>
</body>
</html>
