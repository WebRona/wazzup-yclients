<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wazzup Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        #wazzup-iframe {
            width: 100%;
            height: 100vh;
            border: none;
            display: block;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 16px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
        }
        
        .error h2 {
            color: #f44336;
            margin-bottom: 10px;
        }
        
        .error p {
            color: #666;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Загрузка чата...</p>
    </div>
    
    <div id="error" class="error" style="display: none;">
        <h2>⚠️ Ошибка</h2>
        <p id="error-message"></p>
    </div>
    
    <iframe id="wazzup-iframe" style="display: none;"></iframe>

    <script>
        // КОНФИГУРАЦИЯ
        const CONFIG = {
            // ВАШ API КЛЮЧ WAZZUP
            apiKey: 'f766c59becb94605b6d0cd84a5b5613e',
            
            // Базовый URL для iframe
            baseUrl: 'https://api.wazzup24.com/v3/iframe',
            
            // Канал по умолчанию (whatsapp, instagram, telegram)
            defaultTransport: 'whatsapp'
        };

        // Функция для получения параметров из URL
        function getUrlParams() {
            const params = {};
            const searchParams = new URLSearchParams(window.location.search);
            
            for (const [key, value] of searchParams.entries()) {
                params[key] = value;
            }
            
            return params;
        }

        // Функция для очистки номера телефона
        function cleanPhone(phone) {
            if (!phone) return '';
            
            // Удаляем все кроме цифр
            let cleaned = phone.replace(/\D/g, '');
            
            // Убираем начальные 8 и заменяем на 7 для России
            if (cleaned.startsWith('8') && cleaned.length === 11) {
                cleaned = '7' + cleaned.substring(1);
            }
            
            // Для Индонезии оставляем как есть
            if (cleaned.startsWith('62')) {
                return cleaned;
            }
            
            // Для России добавляем 7 если нужно
            if (cleaned.length === 10 && cleaned[0] === '9') {
                cleaned = '7' + cleaned;
            }
            
            return cleaned;
        }

        // Функция для отображения ошибки
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        // Функция для загрузки Wazzup iframe
        function loadWazzupChat() {
            try {
                // Получаем параметры от Yclients
                const params = getUrlParams();
                
                console.log('Параметры от Yclients:', params);
                
                // Извлекаем номер телефона
                // Yclients может передавать phone, client_phone, или другие поля
                let phone = params.phone || params.client_phone || params.clientPhone || '';
                
                // Если телефона нет, пробуем получить из других полей
                if (!phone && params.client) {
                    try {
                        const client = JSON.parse(params.client);
                        phone = client.phone || '';
                    } catch (e) {
                        console.error('Ошибка парсинга client:', e);
                    }
                }
                
                // Очищаем номер
                phone = cleanPhone(phone);
                
                console.log('Очищенный номер:', phone);
                
                // Проверяем наличие телефона
                if (!phone) {
                    showError('Номер телефона не указан. Убедитесь, что у клиента есть номер телефона в карточке.');
                    return;
                }
                
                // Формируем URL для iframe
                let iframeUrl = `${CONFIG.baseUrl}?token=${CONFIG.apiKey}&phone=${phone}`;
                
                // Добавляем канал если указан
                const transport = params.transport || CONFIG.defaultTransport;
                if (transport) {
                    iframeUrl += `&transport=${transport}`;
                }
                
                // Добавляем chatId если есть
                if (params.chatId) {
                    iframeUrl += `&chatId=${params.chatId}`;
                }
                
                console.log('URL iframe:', iframeUrl);
                
                // Загружаем iframe
                const iframe = document.getElementById('wazzup-iframe');
                iframe.src = iframeUrl;
                
                // Показываем iframe после загрузки
                iframe.onload = function() {
                    document.getElementById('loading').style.display = 'none';
                    iframe.style.display = 'block';
                };
                
                // Обработка ошибок загрузки
                iframe.onerror = function() {
                    showError('Не удалось загрузить чат. Проверьте настройки API ключа.');
                };
                
            } catch (error) {
                console.error('Ошибка:', error);
                showError('Произошла ошибка при загрузке чата: ' + error.message);
            }
        }

        // Запускаем при загрузке страницы
        window.addEventListener('DOMContentLoaded', loadWazzupChat);
        
        // Обработка сообщений от Yclients (если будут)
        window.addEventListener('message', function(event) {
            console.log('Получено сообщение:', event.data);
            
            // Здесь можно обрабатывать сообщения от Yclients
            // Например, обновление номера телефона
            if (event.data && event.data.phone) {
                const phone = cleanPhone(event.data.phone);
                if (phone) {
                    // Перезагружаем iframe с новым номером
                    const iframe = document.getElementById('wazzup-iframe');
                    iframe.src = `${CONFIG.baseUrl}?token=${CONFIG.apiKey}&phone=${phone}&transport=${CONFIG.defaultTransport}`;
                }
            }
        });
    </script>
</body>
</html>
