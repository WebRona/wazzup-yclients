<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <!-- Фиксированная ширина под iframe YCLIENTS -->
  <meta name="viewport" content="width=374">
  <title>Wazzup для YCLIENTS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 374px;
      height: 100vh;
      overflow: hidden;
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #222;
    }

    /* Верхняя панель */
    .topbar {
      height: 44px;
      padding: 0 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #f0f0f0;
      background: #ffffff;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #25D366, #128C7E);
    }

    .topbar-title {
      font-size: 14px;
      font-weight: 600;
      color: #222;
    }

    .topbar-logout {
      border: none;
      background: transparent;
      font-size: 12px;
      color: #999;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .topbar-logout:hover {
      background: #f5f5f5;
    }

    /* Контейнеры */
    #loader,
    #error,
    #chat-container {
      width: 100%;
      height: calc(100vh - 44px); /* минус topbar */
    }

    /* Loader */
    .loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #666;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #25D366;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    .loader p {
      font-size: 14px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Error State */
    .error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
    }

    .error h3 {
      font-size: 18px;
      color: #333;
      margin-bottom: 8px;
    }

    .error p {
      font-size: 14px;
      color: #666;
      margin-bottom: 16px;
    }

    .error button {
      padding: 10px 20px;
      background: #25D366;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .error button:hover {
      background: #1ebe57;
    }

    /* Chat Container */
    #chat-container {
      position: relative;
    }

    #wazzup-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Utility */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Верхняя панель -->
  <header class="topbar">
    <div class="topbar-left">
      <span class="logo-dot"></span>
      <span class="topbar-title">Чаты Wazzup</span>
    </div>
    <button id="logout-btn" class="topbar-logout" type="button">
      Выйти
    </button>
  </header>

  <!-- Loader -->
  <div id="loader" class="loader">
    <div class="spinner"></div>
    <p>Загрузка мессенджеров...</p>
  </div>

  <!-- Error State -->
  <div id="error" class="error hidden">
    <h3>Не удалось загрузить чаты</h3>
    <p id="error-message"></p>
    <button id="retry-btn" type="button">Попробовать снова</button>
  </div>

  <!-- Main iframe container -->
  <div id="chat-container" class="hidden">
    <iframe
      id="wazzup-iframe"
      frameborder="0"
      allow="microphone *; clipboard-write *"
      allowfullscreen
      title="Чаты Wazzup">
    </iframe>
  </div>

  <script>
    // ======= КОНФИГ (фронтовый прототип) =======
    const CONFIG = {
      WAZZUP_IFRAME_BASE: 'https://app.wazzup24.com/iframe',
      AUTH_REQUIRED: false
    };

    // ======= Утилиты: телефон =======
    function formatPhone(phone) {
      if (!phone) return null;
      let cleaned = String(phone).replace(/\D/g, '');
      if (cleaned.startsWith('8') && cleaned.length === 11) {
        cleaned = '7' + cleaned.slice(1); // РФ 8XXXXXXXXXX -> 7XXXXXXXXXX
      }
      if (cleaned.length === 10) {
        cleaned = '7' + cleaned; // без кода страны считаем РФ
      }
      return '+' + cleaned;
    }

    function isValidPhone(phone) {
      if (!phone) return false;
      const cleaned = String(phone).replace(/\D/g, '');
      return cleaned.length >= 10 && cleaned.length <= 15;
    }

    // ======= Псевдо‑авторизация =======
    function isAuthorized() {
      if (!CONFIG.AUTH_REQUIRED) return true;
      return !!localStorage.getItem('wazzup_yclients_auth');
    }

    function logout() {
      localStorage.removeItem('wazzup_yclients_auth');
      try {
        window.parent.postMessage({ type: 'logout' }, '*');
      } catch (e) {}
      location.reload();
    }

    function showAuthError() {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-message').textContent =
        'Требуется авторизация для работы с мессенджерами.';
    }

    // ======= UI ошибки =======
    function showError(message) {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('chat-container').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-message').textContent =
        message || 'Произошла неизвестная ошибка.';
    }

    // ======= Wazzup iframe =======
    function buildWazzupUrlCard(phone) {
      const params = new URLSearchParams({
        scope: 'card',
        phone: phone
      });
      return CONFIG.WAZZUP_IFRAME_BASE + '?' + params.toString();
    }

    function buildWazzupUrlGlobal() {
      const params = new URLSearchParams({
        scope: 'global'
      });
      return CONFIG.WAZZUP_IFRAME_BASE + '?' + params.toString();
    }

    function loadIframe(url) {
      const iframe = document.getElementById('wazzup-iframe');
      if (!iframe) return;

      console.log('[loadIframe] url =', url);
      iframe.src = url;

      iframe.onload = function () {
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('error').classList.add('hidden');
        document.getElementById('chat-container').classList.remove('hidden');
        try {
          window.parent.postMessage({ type: 'ready' }, '*');
        } catch (e) {}
      };

      iframe.onerror = function () {
        showError('Не удалось загрузить интерфейс Wazzup');
      };
    }

    // ======= Работа с YCLIENTS (вкладки employee/client/visit) =======
    function sendIframeReady(success) {
      try {
        window.parent.postMessage({
          type: 'iframe_ready',
          payload: { success: success }
        }, '*');
        console.log('[YCLIENTS] iframe_ready sent');
      } catch (e) {
        console.warn('[YCLIENTS] iframe_ready error', e);
      }
    }

    function requestEntity() {
      try {
        window.parent.postMessage({ type: 'iframe_request_entity' }, '*');
        console.log('[YCLIENTS] iframe_request_entity sent');
      } catch (e) {
        console.warn('[YCLIENTS] iframe_request_entity error', e);
      }
    }

    function extractPhoneFromEntity(msg) {
      if (!msg || msg.type !== 'yclients_response_entity' || !msg.payload) {
        return null;
      }
      const { entity_type, entity } = msg.payload;
      console.log('[YCLIENTS] entity_type =', entity_type, 'entity =', entity);

      if (!entity) return null;

      if (entity_type === 'client') {
        return entity.phone || (entity.comer && entity.comer.phone) || null;
      }

      if (entity_type === 'visit') {
        if (entity.client) {
          return entity.client.phone ||
                 (entity.client.comer && entity.client.comer.phone) ||
                 null;
        }
      }

      // Для employee, как правило, нет телефона клиента — вернем null
      return null;
    }

    // ======= Главная логика =======
    const urlParams = new URLSearchParams(window.location.search);
    const salonId   = urlParams.get('salon_id');
    const userId    = urlParams.get('user_id');
    const entityId  = urlParams.get('entity_id');
    const entityType = urlParams.get('entity_type'); // employee | visit | client

    // Тестовый режим: можно передать client_phone напрямую
    const testClientPhone = urlParams.get('client_phone');

    function validateBaseParamsIfAny() {
      // Для вкладок employee/visit/client по документации всегда будет salon_id и entity_type.
      // Но если страница открыта напрямую для теста — не ломаемся.
      if (!entityType && !testClientPhone) {
        console.log('[init] entity_type и client_phone не переданы — ожидаем открытие из YCLIENTS или тестовый режим.');
      }
    }

    function checkAuthOrFail() {
      if (!isAuthorized()) {
        showAuthError();
        throw new Error('Not authorized');
      }
    }

    function init() {
      console.log('[init] start', { salonId, userId, entityId, entityType, testClientPhone });

      document.getElementById('logout-btn').addEventListener('click', logout);
      document.getElementById('retry-btn').addEventListener('click', function () {
        location.reload();
      });

      try {
        validateBaseParamsIfAny();
        checkAuthOrFail();

        // 1) ТЕСТОВЫЙ РЕЖИМ — client_phone в query
        if (testClientPhone) {
          const formatted = formatPhone(testClientPhone);
          console.log('[init] test phone from URL:', testClientPhone, '=>', formatted);
          if (!formatted || !isValidPhone(formatted)) {
            showError('Тестовый номер телефона указан некорректно.');
            return;
          }
          loadIframe(buildWazzupUrlCard(formatted));
          return;
        }

        // 2) РЕЖИМ ВКЛАДОК YCLIENTS
        if (!entityType) {
          // Открыли напрямую без параметров
          showError('Страница должна открываться из YCLIENTS.');
          return;
        }

        // Подписываемся на ответы от YCLIENTS
        window.addEventListener('message', function (event) {
          const data = event.data;
          if (!data || typeof data !== 'object') return;
          console.log('[message] from parent:', data);

          if (data.type === 'yclients_response_entity') {
            // Пришли данные сущности
            const phoneRaw = extractPhoneFromEntity(data);

            if (entityType === 'employee') {
              // Для сотрудника показываем глобальный список чатов
              console.log('[init] entity_type=employee => scope=global');
              loadIframe(buildWazzupUrlGlobal());
              return;
            }

            if (!phoneRaw) {
              showError('У клиента не указан телефон в YCLIENTS.');
              return;
            }

            const formatted = formatPhone(phoneRaw);
            console.log('[init] phone from entity:', phoneRaw, '=>', formatted);

            if (!formatted || !isValidPhone(formatted)) {
              showError('Номер телефона клиента указан некорректно.');
              return;
            }

            loadIframe(buildWazzupUrlCard(formatted));
          }
        });

        // Сообщаем YCLIENTS, что iframe готов, и запрашиваем сущность
        sendIframeReady(true);
        requestEntity();
      } catch (e) {
        console.error('[init] error', e);
        if (!(e instanceof Error && e.message === 'Not authorized')) {
          showError('Ошибка инициализации: ' + (e.message || e));
        }
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
