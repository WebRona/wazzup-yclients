<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wazzup Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <iframe id="wazzup-frame" src="about:blank"></iframe>

    <script>
        const WAZZUP_API_KEY = 'f766c59becb94605b6d0cd84a5b5613e';

        // Функция форматирования номера
        function formatPhone(phone) {
            if (!phone) return null;
            
            let cleaned = phone.replace(/\D/g, '');
            
            // Россия: 7 или 8
            if (cleaned.startsWith('7') && cleaned.length === 11) {
                return '+' + cleaned;
            }
            if (cleaned.startsWith('8') && cleaned.length === 11) {
                return '+7' + cleaned.substring(1);
            }
            
            // Индонезия: 62
            if (cleaned.startsWith('62')) {
                return '+' + cleaned;
            }
            
            // Прочие страны
            if (!cleaned.startsWith('+')) {
                cleaned = '+' + cleaned;
            }
            
            return cleaned;
        }

        // Функция загрузки Wazzup iframe
        function loadWazzup(phone) {
            const formattedPhone = formatPhone(phone);
            
            if (!formattedPhone) {
                console.error('Некорректный номер телефона:', phone);
                return;
            }

            // Формируем URL для Wazzup iframe API
            const wazzupUrl = `https://api.wazzup24.com/v3/iframe?token=${WAZZUP_API_KEY}&phone=${encodeURIComponent(formattedPhone)}&transport=whatsapp`;
            
            console.log('Загружаю Wazzup для номера:', formattedPhone);
            
            // Устанавливаем src для iframe
            document.getElementById('wazzup-frame').src = wazzupUrl;
        }

        // Слушаем сообщения от Yclients
        window.addEventListener('message', function(event) {
            console.log('Получены данные от Yclients:', event.data);
            
            try {
                const data = event.data;
                
                // Ищем номер телефона в разных возможных местах
                let phone = null;
                
                if (data?.client?.phone) {
                    phone = data.client.phone;
                } else if (data?.phone) {
                    phone = data.phone;
                } else if (data?.record?.client?.phone) {
                    phone = data.record.client.phone;
                }
                
                if (phone) {
                    loadWazzup(phone);
                } else {
                    console.error('Номер телефона не найден в данных:', data);
                }
                
            } catch (error) {
                console.error('Ошибка обработки данных:', error);
            }
        });

        // Для тестирования: поддержка прямого URL
        const urlParams = new URLSearchParams(window.location.search);
        const phoneParam = urlParams.get('phone');
        
        if (phoneParam) {
            console.log('Тестовый режим - прямой доступ');
            loadWazzup(phoneParam);
        } else {
            // Сообщаем Yclients что готовы
            window.parent.postMessage({ type: 'ready' }, '*');
            console.log('Ожидание данных от Yclients...');
        }
    </script>
</body>
</html>
